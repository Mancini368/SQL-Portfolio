Using a dataset from Maven Analytics to analyze a year's worth of sales from a pizza place, including the date and time of each order and the pizzas served, with additional details on the type, size, quantity, price, and ingredients.

-- I started by sketching out an EER diagram to determine relationships between primary keys and foreign keys among the 4 tables; order_details, orders, pizzas and pizza_types.
-- I began exploration, cleaning and analysis in BigQuery as follows:
  
SELECT * FROM `sql-project-1-383101.pizza_sales.order_details`;
SELECT * FROM `sql-project-1-383101.pizza_sales.orders`;
SELECT * FROM `sql-project-1-383101.pizza_sales.pizza_type`;
SELECT * FROM `sql-project-1-383101.pizza_sales.pizzas`;

-- alter table to change column names in pizza_type
CREATE TABLE pizza_sales.pizza_type
AS SELECT
  string_field_0 AS pizza_type_id,
  string_field_1 AS name,
  string_field_2 AS category,
  string_field_3 AS ingredients
FROM
  pizza_sales.pizza_types;

-- join the 4 tables to explore all data
SELECT *
FROM `sql-project-1-383101.pizza_sales.orders` AS orders
JOIN `sql-project-1-383101.pizza_sales.order_details` AS order_details
  ON orders.order_id=order_details.order_id
JOIN `sql-project-1-383101.pizza_sales.pizzas` AS pizzas
  ON order_details.pizza_id=pizzas.pizza_id
JOIN `sql-project-1-383101.pizza_sales.pizza_type` AS pizza_type
  ON pizzas.pizza_type_id=pizza_type.pizza_type_id
;

SELECT COUNT(*) FROM `sql-project-1-383101.pizza_sales.orders`;         --21350 total table orders
SELECT COUNT(*) FROM `sql-project-1-383101.pizza_sales.order_details`   --48620 total pizzas ordered

-- How many orders per day? What day of the week do the orders pertain to? Group by date and order by largest number of orders per day to least. 
SELECT
  date,
  COUNT(DISTINCT order_details.order_details_id) AS order_count,
  FORMAT_TIMESTAMP('%A', date) AS day_of_week
FROM `sql-project-1-383101.pizza_sales.order_details` AS order_details
JOIN `sql-project-1-383101.pizza_sales.orders` AS orders
  ON orders.order_id=order_details.order_id
 GROUP BY date
 ORDER BY orders_per_day DESC;

-- Average number of orders per day of the week
SELECT 
  EXTRACT(DAYOFWEEK FROM date) AS day_of_week, 
  AVG(order_count) AS average_orders_per_day,
FROM (
    SELECT 
      date, 
      COUNT(DISTINCT order_details.order_details_id ) AS order_count,
  FROM `sql-project-1-383101.pizza_sales.order_details` AS order_details
    JOIN `sql-project-1-383101.pizza_sales.orders` AS orders
    ON orders.order_id=order_details.order_id
    GROUP BY date, time
)
GROUP BY day_of_week;
 


 -- peak hours of buisness
SELECT EXTRACT(HOUR FROM TIMESTAMP(DATETIME(orders.date, orders.time))) AS hour_of_day,
       COUNT(*) AS order_count
FROM `sql-project-1-383101.pizza_sales.order_details` AS order_details
    JOIN `sql-project-1-383101.pizza_sales.orders` AS orders
    ON orders.order_id=order_details.order_id
GROUP BY hour_of_day
ORDER BY order_count DESC;

